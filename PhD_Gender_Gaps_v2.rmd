---
title: "Job Market Analysis for PhD Graduates"
author: "Xu Dong, University of Miami"
Organization: "University of Miami"
date: "May 15, 2018"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, message=FALSE, warning=FALSE)
```


The following report includes three analytical insights from investigating the job market for PhD graduates in the US, *i.e.*, 

* Does gender matter?
* Does my major matter?
* Does my school location matter? 

# 1. Does gender matter? 

To answer this question, I scrapped the data ssing R package "rvest" from multiple tables on the National Center for Education Statistics website (https://nces.ed.gov/programs/digest/).

##### Figure 1. Percentage of PhD's degrees conferred to women in the US (1950-2017)

```{r fig1}
library("ggplot2")
library(xlsx)
table = read.xlsx("C:/Users/Xu Dong/Desktop/Jobs/The data Incubator/2018 Spring Session/Finalist/PhD_Gender_Gaps/raw.xlsx",2)
ggplot(table, aes(x = Year, y = Percentage, colour = Program)) + geom_point(size=0.9)+
  geom_smooth(method = 'loess', se = FALSE)
```


##### Figure 2. The difference amount of PhD's degrees conferred to men against women (Year 2017)

```{r job_major}

library("xlsx")

degree_by_major <- read.xlsx("tb2.xlsx",3)
degree_by_major = degree_by_major[order(degree_by_major$Gen_Diff),]

par(mar=c(10,10,1,2))
plot(degree_by_major$Gen_Diff,type="p",   xaxt="n", ylab=" Differences of amount", xlab = "")

axis(1, at=1:22, labels=degree_by_major$Major, las = 2, cex.axis=0.9)


```



```{r cars}

# Load packages
library(rvest)
library(stringr)
library(dplyr)
library(ggplot2)

# Indeed Search Words
# job_title <- "\"Data+Scientist\""
# location <- "Chicago%2C+IL"
location <- "Nationwide"
BASE_URL <- "https://www.indeed.com"


ADV_URL <- paste0('https://www.indeed.com/jobs?as_and=PhD&as_not=&as_cmp=&jt=all&st=&salary=&sr=directhire&radius=25&fromage=any&limit=50&sort=date&psf=advsrch&as_any=&as_phr=&l=', location)

# get the html file from search url
start_page <- read_html(ADV_URL)

# Get start page job URLs
links <- start_page %>%
  html_nodes("h2 a") %>%
  html_attr('href')

# Get result page links
page.links <- start_page %>%
  html_nodes(xpath = '//div[contains(@class,"pagination")]//a') %>%
  html_attr('href')

KEYWORDS <- as.character(degree_by_major$Major)


# Clean the raw html - removing commas, tabs, line changers, etc  
clean.text <- function(text)
{
  str_replace_all(text, regex('\r\n|\n|\t|\r|,|/|<|>|\\.'), ' ')
}

# Given running total dataframe and links to scrape skills and compute running total
ScrapeJobLinks <- function(res, job.links){
  for(i in 1:length(job.links)){
    job.url <- paste0(BASE_URL,job.links[i])
    
    # Sys.sleep(1)
    # cat(paste0('Reading job ', i, '\n'))
    
    tryCatch({
      html <- read_html(job.url)
      text <- html_text(html)
      text <- clean.text(text)
      df <- data.frame(skill = KEYWORDS, count = ifelse(str_detect(text, regex(KEYWORDS, ignore_case = T)), 1, 0))
      res$running$count <- res$running$count + df$count
      res$num_jobs <- res$num_jobs + 1
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
    # cat(paste0('job.links\n'))
  }
  
  return(res)
}

# For display purpose, we also need the \\b removed from the keyword set
KEYWORDS_DISPLAY <- KEYWORDS

# Create running total dataframe
running <- data.frame(skill = KEYWORDS_DISPLAY, count = rep(0, length(KEYWORDS_DISPLAY)))

# Since the indeed only display max of 20 pages from search result, we cannot use job_count but need to track by creating a num_jobs
num_jobs <- 0

# Here is our results object that contains the two stats
results <- list("running" = running, "num_jobs" = num_jobs)

job_count = 1
if(job_count != 0){
  # cat('Scraping jobs in Start Page\n')
  results <- ScrapeJobLinks(results, links)
}

for(p in 1:(length(page.links)-1)){
#for(p in 1:2){ 
  
  # cat('Moving to Next 50 jobs\n')
  
  # Navigate to next page
  new.page <- read_html(paste0(BASE_URL, page.links[p]))
  
  # Get new page job URLs
  links <- new.page %>%
    html_nodes("h2 a") %>%
    html_attr('href')
  
  # Scrap job links
  results <- ScrapeJobLinks(results, links)
}

# print(arrange(results$running, -count))

```


#2. Does my major matter?

In order to address the concern about the gender disparty in post-PhD job opportunities, I conducted an analysis on the recent jobs opportunities posted online that required/preferred a PhD degree. I scrapped and analyzed 27,000+ jobs postings on indeed.com (https://indeed.com/jobs?q=PhD).
Note here that the jobs posts in indeed.com have dupulicates.I used text mining techniques to compare the similarity of the bag of words between any given pair of job posts. If their similarity are over 95%, I took them as the same post.


#### Figure 3. Major occurrences(%) in PhD Job Postings on indeed.com



```{r}
# running total count as percentage
results$running$count<-results$running$count/results$num_jobs

# Reformat the Job Title and Location to readable form
# jt <- str_replace_all(job_title, '\\+|\\\"', ' ')
# loc <- str_replace_all(location, '\\%2C+|\\+',' ')

# Visualization
p <- ggplot(results$running, aes(reorder(Major,-count), count)) + geom_bar(stat="identity") + 
  labs(x = 'Major', y = 'Occurrences (%)', title = "Major occurrences(%) in PhD Job Postings on indeed.com") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p + scale_y_continuous(labels = scales::percent, breaks = seq(0,1,0.1)) 
```

#### Figure 4. Gender Gaps of Job Opportunities Induced by PhD programs 

```{r gap}
names(results$running)[1] = "Major"
gap = merge(results$running, degree_by_major, by = "Major")
plot(gap$count, gap$Gen_Diff, ylab = "Amount diff. of degrees conferred to men against women", xlab = "Percentage of job postings by majors")
```

# 3. Does my school location matter? 

Assuming that employers prefer to recruit talents in local areas, this analysis tends to find whether the program location will give PhD graduates a privilege for finding a job. Data are scrapped from National Science Fundation website (www.nsf.gov/statistics/) and indeed.com (https://indeed.com/jobs?q=PhD) on Feb 20th, 2018.

#### Figure 5. Number of Job for PhDs by states (Data scrapped from indeed.com)
```{r job_location}

# library(rvest)
# library(stringr)
# library(dplyr)
# library(ggplot2)

state_set = state.abb
state_count <- data.frame(State = state_set, count = rep(0, length(state_set)))

for (s in state_set) {

  state_ini_page <- read_html(paste0('https://www.indeed.com/jobs?q=PhD&radius=25&sort=date&l=', s))
  job_count <- unlist(strsplit(state_ini_page %>% 
                               html_node("#searchCount") %>%
                               html_text(), split = ' ')) 
  job_count <- as.numeric(str_replace_all(job_count[length(job_count)-1],',',''))
  state_count[state_count$State == s, 2] <- job_count
  # cat('Total job count: ', job_count) 
}

names(state_count)[1] <- "state"
state_count$states <- tolower(state.name[match(state_count$state,  state.abb)])

all_states <- map_data("state")
state_count$region <- state_count$states
Total <- merge(all_states, state_count, by="region")


ggplot() +
  geom_map(data=Total, aes(x=long, y=lat, group = group, fill=count),colour="white", map = all_states, map_id = Total$states) +
  scale_fill_continuous(low = "thistle2", high = "darkred", guide="colorbar") +
  labs(x = "", y = "", title = "PhD Jobs counts in US")


```

#### Figure 6. Number of PhD degree conferred by states 

```{r degree_by_state}
library("xlsx")

degree_by_state <- read.xlsx("tb1.xlsx",1)
state_count$degree_conferred_2014_15 <- degree_by_state$count
Total <- merge(all_states, state_count, by="region")


ggplot() +
  geom_map(data=Total, aes(x=long, y=lat, group = group, fill=degree_conferred_2014_15),colour="white",              map = all_states, map_id = Total$states) +
  scale_fill_continuous(low = "thistle2", high = "darkblue", guide="colorbar") +
  labs(x = "", y = "", title = "Number of PhD degrees conferred by states in 2016-17")+ labs(fill = "Amount")

```

#### Figure 7.  PhD Job Index by states

By simply dividing the job posting amount by the number of PhD degree conferred for each state in the US, I proposed a measure, called *Location Privilege Index (LPI)*, to quantify the job finding privilege induced by location for post-PhD career. 

```{r index}

state_count$PhD_Job_Index <- state_count$count / state_count$degree_conferred_2014_15
Total <- merge(all_states, state_count, by="region")


ggplot() +
  geom_map(data=Total, aes(x=long, y=lat, group = group, fill = PhD_Job_Index),colour="white", 
           map = all_states, map_id = Total$states) +
  scale_fill_continuous(low = "thistle2", high = "darkgreen", guide="colorbar") +
  labs(x = "", y = "", title = "Index value")+ labs(fill = "LPI")

```





